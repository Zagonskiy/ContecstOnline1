<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL_LINK // ONLINE</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* (СТИЛИ ТЕ ЖЕ, ЧТО БЫЛИ РАНЬШЕ - ОСТАВЛЯЕМ БЕЗ ИЗМЕНЕНИЙ) */
        :root { --bg-color: #050a14; --terminal-bg: #0a0f0f; --neon-main: #00f3ff; --neon-warn: #ff0055; --neon-success: #00ff41; --blur-amount: 0.7px; }
        body { background-color: var(--bg-color); margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; font-family: 'VT323', monospace; overflow: hidden; color: var(--neon-main); }
        .crt-container { position: relative; width: 90%; max-width: 800px; height: 80vh; background-color: var(--terminal-bg); border: 2px solid var(--neon-main); border-radius: 20px; box-shadow: 0 0 20px var(--neon-main); padding: 20px; display: flex; flex-direction: column; }
        .crt-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(rgba(18,16,16,0) 50%, rgba(0,0,0,0.25) 50%); background-size: 100% 4px; pointer-events: none; z-index: 10; }
        .glow-text { text-shadow: 0 0 5px var(--neon-main); filter: blur(var(--blur-amount)); }
        .text-warn { color: var(--neon-warn); text-shadow: 0 0 5px var(--neon-warn); }
        .text-success { color: var(--neon-success); text-shadow: 0 0 5px var(--neon-success); }
        .screen { display: none; height: 100%; flex-direction: column; z-index: 5; }
        .screen.active { display: flex; }
        h1 { text-align: center; }
        .cyber-input { background: transparent; border: none; border-bottom: 2px solid var(--neon-main); color: var(--neon-main); font-family: 'VT323', monospace; font-size: 1.5rem; width: 100%; outline: none; text-align: center; margin-bottom: 20px; text-transform: uppercase; }
        .cyber-btn { background: transparent; border: 1px solid var(--neon-main); color: var(--neon-main); padding: 10px; font-family: 'VT323', monospace; font-size: 1.2rem; cursor: pointer; text-transform: uppercase; margin: 5px; }
        .cyber-btn:hover { background: var(--neon-main); color: #000; box-shadow: 0 0 15px var(--neon-main); }
        #game-log { flex-grow: 1; border: 1px solid rgba(0, 243, 255, 0.3); padding: 10px; overflow-y: auto; margin-bottom: 10px; background: rgba(0,0,0,0.3); }
        .game-header { display: flex; justify-content: space-between; border-bottom: 1px solid var(--neon-main); margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="crt-container">
        <div class="crt-overlay"></div>
        
        <div id="menu-screen" class="screen active">
            <h1 class="glow-text">NEURAL_LINK ONLINE</h1>
            <input type="text" id="username" class="cyber-input" placeholder="ВВЕДИТЕ НИКНЕЙМ">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="cyber-btn" onclick="initCreateLobby()">СОЗДАТЬ УЗЕЛ</button>
                <button class="cyber-btn" onclick="document.getElementById('join-area').style.display='block'">ПОДКЛЮЧИТЬСЯ</button>
            </div>
            <div id="join-area" style="display: none; margin-top: 20px; text-align: center;">
                <input type="text" id="lobby-code-input" class="cyber-input" placeholder="КОД (4 ЦИФРЫ)">
                <button class="cyber-btn" onclick="initJoinLobby()">ВЗЛОМАТЬ</button>
            </div>
        </div>

        <div id="setup-screen" class="screen" style="justify-content: center; align-items: center;">
            <h2 class="glow-text">УЗЕЛ СОЗДАН: <span id="display-code" class="text-success">----</span></h2>
            <p>ОЖИДАНИЕ ВТОРОГО ИГРОКА...</p>
            <div id="word-setup-area" style="display:none; width: 80%; text-align: center;">
                <p class="text-success">ИГРОК ПОДКЛЮЧЕН!</p>
                <p>ЗАГАДАЙТЕ СЛОВО ДЛЯ НЕГО:</p>
                <input type="text" id="secret-word-input" class="cyber-input" placeholder="СЛОВО...">
                <button class="cyber-btn" onclick="setWordAndStart()">ЗАПУСТИТЬ ПРОТОКОЛ</button>
            </div>
        </div>

        <div id="waiting-screen" class="screen" style="justify-content: center; align-items: center;">
            <h2 class="glow-text">СВЯЗЬ УСТАНОВЛЕНА</h2>
            <p>ХОСТ ВЫБИРАЕТ ЦЕЛЬ...</p>
            <div class="loader">[ . . . . . ]</div>
        </div>

        <div id="game-screen" class="screen">
            <div class="game-header glow-text">
                <span id="vs-player">VS: ???</span>
                <span>ОЧКИ: <span id="score-val">1000</span></span>
            </div>
            <div id="game-log"></div>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="game-input" class="cyber-input" placeholder="ВВЕДИТЕ КОД..." style="margin-bottom: 0;">
                <button class="cyber-btn" onclick="makeGuess()">SEND</button>
            </div>
        </div>
    </div>

    <script>
        // --- ВСТАВЬ СЮДА СВОЙ КОНФИГ ИЗ FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCpX1V_alfcU1VxOSdMG01TN_AcFdfw4mU",
            authDomain: "contecstonline.firebaseapp.com",
            databaseURL: "https://contecstonline-default-rtdb.firebaseio.com",
            projectId: "contecstonline",
            storageBucket: "contecstonline.firebasestorage.app",
            messagingSenderId: "1091016267262",
            appId: "1:1091016267262:web:f26ac35123ba580bf75caf",
        };

        // Инициализация
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();

        // --- ПЕРЕМЕННЫЕ ---
        let myName = "";
        let currentLobby = "";
        let myRole = ""; // 'host' или 'guest'
        let targetWord = "";
        let score = 1000;

        // --- ФУНКЦИИ МЕНЮ ---

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function initCreateLobby() {
            myName = document.getElementById('username').value || "Unknown";
            const code = Math.floor(1000 + Math.random() * 9000).toString();
            currentLobby = code;
            myRole = 'host';

            // Создаем запись в БД
            db.ref('lobbies/' + code).set({
                host: myName,
                guest: "",
                status: "waiting", // waiting, setup, playing
                targetWord: "",
                logs: {}
            });

            document.getElementById('display-code').innerText = code;
            showScreen('setup-screen');
            listenToLobby();
        }

        function initJoinLobby() {
            myName = document.getElementById('username').value || "Unknown";
            const code = document.getElementById('lobby-code-input').value;
            currentLobby = code;
            myRole = 'guest';

            // Проверяем, существует ли комната
            db.ref('lobbies/' + code).once('value', (snapshot) => {
                if (snapshot.exists()) {
                    // Присоединяемся
                    db.ref('lobbies/' + code).update({
                        guest: myName,
                        status: "setup"
                    });
                    showScreen('waiting-screen');
                    listenToLobby();
                } else {
                    alert("ОШИБКА: Узел не найден!");
                }
            });
        }

        // --- СЕТЕВАЯ МАГИЯ (СЛУШАЕМ ИЗМЕНЕНИЯ) ---

        function listenToLobby() {
            const lobbyRef = db.ref('lobbies/' + currentLobby);

            lobbyRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                // 1. Если зашел гость, хост видит поле ввода слова
                if (myRole === 'host' && data.status === 'setup' && document.getElementById('word-setup-area').style.display === 'none') {
                    document.getElementById('word-setup-area').style.display = 'block';
                }

                // 2. Если игра началась
                if (data.status === 'playing') {
                    if (document.getElementById('game-screen').classList.contains('active') === false) {
                        targetWord = data.targetWord; // Получаем слово с сервера
                        showScreen('game-screen');
                        document.getElementById('vs-player').innerText = "VS: " + (myRole === 'host' ? data.guest : data.host);
                        addToLog("СИСТЕМА СИНХРОНИЗИРОВАНА.", "success");
                        if(myRole === 'guest') {
                            addToLog("ЗАДАЧА: УГАДАТЬ СЛОВО (ДЛИНА: " + targetWord.length + ")", "warn");
                        } else {
                            addToLog("ВЫ ЗАГАДАЛИ: " + targetWord, "warn");
                            addToLog("ОЖИДАЙТЕ ДЕЙСТВИЙ ПРОТИВНИКА...", "system");
                            document.getElementById('game-input').disabled = true; // Хост не пишет
                        }
                    }
                }

                // 3. Обновление логов (ходов)
                updateLogs(data.logs);
            });
        }

        // --- ЛОГИКА ХОСТА (ЗАГАДАТЬ СЛОВО) ---
        function setWordAndStart() {
            const word = document.getElementById('secret-word-input').value.trim().toUpperCase();
            if (!word) return alert("Введите слово!");

            db.ref('lobbies/' + currentLobby).update({
                targetWord: word,
                status: "playing"
            });
        }

        // --- ЛОГИКА ГОСТЯ (УГАДЫВАТЬ) ---
        function makeGuess() {
            if (myRole === 'host') return; // Хост не угадывает

            const input = document.getElementById('game-input');
            const guess = input.value.trim().toUpperCase();
            if (!guess) return;

            // Считаем близость (на клиенте для скорости)
            const percent = calculateSimilarity(targetWord, guess);
            
            // Отправляем ход в БД
            const newLogKey = db.ref('lobbies/' + currentLobby + '/logs').push().key;
            db.ref('lobbies/' + currentLobby + '/logs/' + newLogKey).set({
                player: myName,
                text: guess,
                similarity: percent,
                timestamp: Date.now()
            });

            // Если угадал
            if (guess === targetWord) {
                // Можно добавить статус победы в БД
                addToLog("ВЗЛОМ УСПЕШЕН!", "success");
            }

            input.value = '';
        }

        // Отображение новых сообщений
        let lastLogCount = 0;
        function updateLogs(logs) {
            if (!logs) return;
            const entries = Object.values(logs).sort((a, b) => a.timestamp - b.timestamp);
            
            // Если количество сообщений увеличилось, рендерим новые
            if (entries.length > lastLogCount) {
                const gameLog = document.getElementById('game-log');
                gameLog.innerHTML = ""; // Очищаем и перерисовываем всё (простой вариант)
                
                entries.forEach(entry => {
                    let colorClass = "text-warn";
                    if (entry.similarity > 40) colorClass = "glow-text";
                    if (entry.similarity > 70) colorClass = "text-success";
                    if (entry.similarity === 100) colorClass = "text-success";

                    const div = document.createElement('div');
                    div.className = "log-entry";
                    // Если это сообщение игрока
                    if (entry.similarity !== undefined) {
                        div.innerHTML = `<span style="color:#fff">${entry.player}:</span> <span class="${colorClass}">${entry.text} [${entry.similarity}%]</span>`;
                    }
                    gameLog.appendChild(div);
                });
                gameLog.scrollTop = gameLog.scrollHeight;
                
                // Штраф очков за каждую попытку
                if (myRole === 'guest') {
                    score = 1000 - (entries.length * 50);
                    if (score < 0) score = 0;
                    document.getElementById('score-val').innerText = score;
                }
                
                lastLogCount = entries.length;
            }
        }

        function addToLog(msg, type) {
            const gameLog = document.getElementById('game-log');
            const div = document.createElement('div');
            div.innerText = "> " + msg;
            if (type === 'warn') div.classList.add('text-warn');
            if (type === 'success') div.classList.add('text-success');
            gameLog.appendChild(div);
        }

        // (Функция Левенштейна осталась той же - скопируй её из прошлого ответа, если нужно, или я добавлю её сюда)
        function calculateSimilarity(s1, s2) {
            let longer = s1, shorter = s2;
            if (s1.length < s2.length) { longer = s2; shorter = s1; }
            if (longer.length === 0) return 100;
            return Math.round(((longer.length - levenshtein(s1, s2)) / longer.length) * 100);
        }
        function levenshtein(a, b) {
            const matrix = [];
            for(let i=0; i<=b.length; i++) matrix[i] = [i];
            for(let j=0; j<=a.length; j++) matrix[0][j] = j;
            for(let i=1; i<=b.length; i++){
                for(let j=1; j<=a.length; j++){
                    if(b.charAt(i-1) == a.charAt(j-1)) matrix[i][j] = matrix[i-1][j-1];
                    else matrix[i][j] = Math.min(matrix[i-1][j-1]+1, matrix[i][j-1]+1, matrix[i-1][j]+1);
                }
            }
            return matrix[b.length][a.length];
        }

    </script>
</body>
</html>
